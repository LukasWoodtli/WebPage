{
    "componentChunkName": "component---src-templates-blog-post-tsx",
    "path": "/blog/arm_stack_frame",
    "result": {"data":{"site":{"siteMetadata":{"title":"My personal Website"}},"markdownRemark":{"id":"fdbb46f9-aa21-5f53-9f95-8e4417eccfed","excerpt":"This page contains notes about the usual stack frame layout (calling convention) on ARM processors. Most information is taken from ARM procedure callingâ€¦","html":"<p>This page contains notes about the usual stack frame layout (calling convention) on ARM processors.</p>\n<p>Most information is taken from <a href=\"http://de.slideshare.net/StephanCadene/arm-procedure-calling-conventions-and-recursion\">ARM procedure calling conventions and recursion </a>.</p>\n<p>The conventions are defined by ARM and are called <a href=\"http://infocenter.arm.com/help/topic/com.arm.doc.ihi0042e/IHI0042E_aapcs.pdf\">PCSAA</a>.</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Link Register</td>\n<td>Contains the return address of an function call</td>\n</tr>\n<tr>\n<td>Caller</td>\n<td>Code that calles a function</td>\n</tr>\n<tr>\n<td>Callee</td>\n<td>Function that is called by other code</td>\n</tr>\n<tr>\n<td>Frame Pointer</td>\n<td>Points to the actual stack frame (Base Pointer on x86)</td>\n</tr>\n<tr>\n<td>Stack Pointer</td>\n<td>Points always to the top of the stack</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"general-notes\">General Notes</h2>\n<ul>\n<li><code class=\"language-text\">BL</code>and <code class=\"language-text\">BLX</code> use <code class=\"language-text\">R14</code> (<code class=\"language-text\">RL</code>) as link register</li>\n<li>Simple functions (i.e. leaf functions) use <code class=\"language-text\">MOV PC, LR</code> to return to the caller function</li>\n<li><code class=\"language-text\">R0</code> - <code class=\"language-text\">R3</code> are used to pass arguments to the callee (can be overwritten by callee, caller saved)</li>\n<li><code class=\"language-text\">R0</code> contains often the result</li>\n<li><code class=\"language-text\">R4</code> - <code class=\"language-text\">R10</code> must be saved by the called function (callee) if needed\n<ul>\n<li>They must be unchanged after return</li>\n<li>Callee saved</li>\n<li>Restore before return</li>\n</ul>\n</li>\n<li><code class=\"language-text\">R13</code> (<code class=\"language-text\">SP</code>) contains the address of top of the stack (last filled poition)</li>\n<li>Stack is Full-Descending:\n<ul>\n<li><code class=\"language-text\">SP</code> points to the last filled location</li>\n<li>Stack grows downwards (from higher to lower addresses)</li>\n</ul>\n</li>\n</ul>\n<p><code class=\"language-text\">PUSH</code>/<code class=\"language-text\">POP</code>: <code class=\"language-text\">STMFD</code>/<code class=\"language-text\">LDMFD</code> (Store multiple Full-Descent, Load multiple Full-Descent)</p>\n<div class=\"gatsby-highlight\" data-language=\"nasm\"><pre class=\"language-nasm\"><code class=\"language-nasm\">LDMFD <span class=\"token register variable\">SP</span>, {<span class=\"token register variable\">R0</span><span class=\"token operator\">-</span><span class=\"token register variable\">R3</span>}</code></pre></div>\n<p>is equvalent to:</p>\n<div class=\"gatsby-highlight\" data-language=\"nasm\"><pre class=\"language-nasm\"><code class=\"language-nasm\">LDR <span class=\"token register variable\">R0</span>, <span class=\"token operator\">[</span><span class=\"token register variable\">SP</span><span class=\"token operator\">]</span>\nLDR <span class=\"token register variable\">R1</span>, <span class=\"token operator\">[</span><span class=\"token register variable\">SP</span>, #<span class=\"token number\">4</span><span class=\"token operator\">]</span>\nLDR <span class=\"token register variable\">R2</span>, <span class=\"token operator\">[</span><span class=\"token register variable\">SP</span>, #<span class=\"token number\">8</span><span class=\"token operator\">]</span>\nLDR <span class=\"token register variable\">R3</span>, <span class=\"token operator\">[</span><span class=\"token register variable\">SP</span>, #<span class=\"token number\">12</span><span class=\"token operator\">]</span></code></pre></div>\n<p>To alter (update) <code class=\"language-text\">SP</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"nasm\"><pre class=\"language-nasm\"><code class=\"language-nasm\">LDMFD <span class=\"token register variable\">SP</span><span class=\"token operator\">!</span>, {<span class=\"token register variable\">R0</span><span class=\"token operator\">-</span><span class=\"token register variable\">R3</span>}</code></pre></div>\n<p><code class=\"language-text\">LR</code> needs to be saved on stack for <em>non</em>-leaf functions</p>\n<div class=\"gatsby-highlight\" data-language=\"nasm\"><pre class=\"language-nasm\"><code class=\"language-nasm\"><span class=\"token label function\">_func:</span>\n  STMFD <span class=\"token register variable\">SP</span><span class=\"token operator\">!</span>, {<span class=\"token register variable\">R4</span><span class=\"token operator\">-</span><span class=\"token register variable\">R6</span>, LR}\n  <span class=\"token comment\">; ... code of func</span>\n  LDMFD <span class=\"token register variable\">SP</span><span class=\"token operator\">!</span>, {<span class=\"token register variable\">R4</span><span class=\"token operator\">-</span><span class=\"token register variable\">R6</span>, PC} <span class=\"token comment\">; Pushing stacked LR directly to PC => return to caller</span></code></pre></div>\n<ul>\n<li>The order of registers in <code class=\"language-text\">STMFD</code> and <code class=\"language-text\">LDMFD</code> is always the same: lower regisers at lower addresses</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 420px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/2d688317500ca6156a170963f70a14ca/d10fb/arm_stack_frame_example.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 60.12658227848101%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsTAAALEwEAmpwYAAABMUlEQVQoz42S3Y7CIBCFff9HMzEaL2o1plUbWomKypSfA6VsUqJr3ay73xWZyYHDmZn0Y+KY31qpMnlthxAAuAcAuq5Lsq7rtNbOOTOQ6pPXi4mobVsiUgNa6/P57L13zimlptNpURTz+XyxWHDOY4wjsRCCiDjnxhilFIDdbgeAiEIIydrT47vt+/1+Op3W67VzTmsNoKoqAG3bJp9vjMRSyrqu8zz33v9X/ExPSskY22w26ZPW2sPh8EkcY8SAtVZKeTwei6Lw3htjvPd/vBxj3O/3jLHVaiWEKMtyuVwqpW63GxGVZQlAKRVC+DTnGOP1ejXGSCmttenlZPtyuTjnrLUAUhbfaYeBlHbTNIwx/qCqqr7vt9utECLLsjzPZ7NZlmUARnP+uZtvG5rOr5Uv3Ie2G16Hh3UAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Order of Registers on Stack\"\n        title=\"Order of Registers on Stack\"\n        src=\"/static/2d688317500ca6156a170963f70a14ca/d10fb/arm_stack_frame_example.png\"\n        srcset=\"/static/2d688317500ca6156a170963f70a14ca/c26ae/arm_stack_frame_example.png 158w,\n/static/2d688317500ca6156a170963f70a14ca/6bdcf/arm_stack_frame_example.png 315w,\n/static/2d688317500ca6156a170963f70a14ca/d10fb/arm_stack_frame_example.png 420w\"\n        sizes=\"(max-width: 420px) 100vw, 420px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<ul>\n<li>More general stack frame:</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 420px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/5d70154770fb605d3f4c5a32cf1aeca5/d10fb/arm_stack_frame_general.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 60.12658227848101%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsTAAALEwEAmpwYAAABUUlEQVQoz4VSy4rCQBDM/3+QFw/ehAi+QKLoIGommmASTebZM+mZZZ1dV4XVOjRNFf2guiP3DP+M/6TARI8aIgKA+QUAdF0XpK7rpJTGGHVD4CPvfVVVjDHOeZZlSinGmLhBSlmWpbXWGCOEGI1G2+12Op3OZrOiKLz3P8Wc87IsN5uNlDLPc6WUEAIAdrsdADDGENE5F+I9eVq7aZq6rtfrtbWWc661PhwOAMA5D3u+IAptQqemaRaLxWQyoZQaY6y1lNIPxXf32raN47jX6w2HwzRNETFN03fF3vvgsNa6bVtCyHw+v1wuSilE/DDZe7/f77MsWy6X1+s1juN+vz8YDAghzrkwWQiBiB/uXFWVMQYRwz211sHtwGutAUBKCQB/bj8adjweT6dTnudFUZzPZ0qpc44QUtd1kiSr1Wo8HidJAgDfd37zmy8fGvJH5gvDlbFZK0Q9zwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"General Stack Frame\"\n        title=\"General Stack Frame\"\n        src=\"/static/5d70154770fb605d3f4c5a32cf1aeca5/d10fb/arm_stack_frame_general.png\"\n        srcset=\"/static/5d70154770fb605d3f4c5a32cf1aeca5/c26ae/arm_stack_frame_general.png 158w,\n/static/5d70154770fb605d3f4c5a32cf1aeca5/6bdcf/arm_stack_frame_general.png 315w,\n/static/5d70154770fb605d3f4c5a32cf1aeca5/d10fb/arm_stack_frame_general.png 420w\"\n        sizes=\"(max-width: 420px) 100vw, 420px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<ul>\n<li>Quick clear down of stack frame: <code class=\"language-text\">MOV SP, FP</code></li>\n</ul>","frontmatter":{"title":"ARM Stack Frame","tags":["Assembler","Embedded Systems","Computer Science"],"category":"Programming"},"headings":[{"depth":2,"value":"General Notes"}]}},"pageContext":{"id":"fdbb46f9-aa21-5f53-9f95-8e4417eccfed","previousPost":{"title":"List of Design Patterns","slug":"/blog/design_patterns"},"nextPost":{"title":"Distance Functions and Metrics","slug":"/blog/distance_functions"},"dates":{"created":1442779935,"modified":1647509701}}},
    "staticQueryHashes": []}